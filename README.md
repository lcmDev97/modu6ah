# 👶 모두의 육아 - Backend

<a href="https://modu6ah.com"><img src="https://user-images.githubusercontent.com/91789496/182133398-7ff4bbd2-96f9-43bc-a996-63522d57607d.png"></a>

## 🏠 [모두의 육아 사이트 주소](https://modu6ah.com)

<hr>

## 🗂️ 목차

### 1. 프로젝트 소개

### 2. 프로젝트 기간

### 3. 팀원 소개

### 4. 주요 기능

### 5. 서비스 아키텍처

### 6. 기술스택

### 7. 라이브러리

### 8. 트러블 슈팅

<hr>

## 👶 1. 프로젝트 소개

#### 공동육아 모집 및 정보 공유 커뮤니티

-  공동육아 함께 할 멤버를 모집하고
-  육아템, 장소 등 다양한 꿀정보를 공유해요!

<br> 

## 🗓 2. 프로젝트 기간

- 2022년 06월 24일 ~ 2022년 08월 05일

<br>

## 🧑‍💻 3. 팀원 소개

<table>
  <tr>
  <td colspan='1' align="center">
  Backend
  </td>
  <td colspan='1' align="center">
  Frontend
  </td>
  <td colspan='1' align="center">
  Designer
  </td>
  <tr>
    <td align="center" >
    <b>이창민</b></a><br>
    <a href="https://github.com/changmin97">Github</a>
    <br><img src="https://img.shields.io/badge/Node.js-339933?style=flat&logo=Node.js&logoColor=white"/><br>
    </td>
    <td align="center">
    <b>김숙영</b></a><br />
    <a href="https://github.com/Maiowol" >Github</a>
    <br><img src="https://img.shields.io/badge/React-61DAFB?style=flat&logo=React&logoColor=white"/><br>
    </td>
    <td align="center">
    <b>서혜빈</b></a><br />
    <a href="https://www.figma.com/file/6oxe17NH1VuhHdZxdj9X9N/항해99_v1">Figma</a>
    </td>
    <tr>
    <td align="center">
    <b>안재훈</b></a><br /> 
    <a href="https://github.com/anjaehun">Github</a>
    <br><img src="https://img.shields.io/badge/Node.js-339933?style=flat&logo=Node.js&logoColor=white"/><br>
    </td>
    <td align="center">
    <b>정인성</b></a><br /> 
    <a href="https://github.com/inseongei">Github</a>
    <br><img src="https://img.shields.io/badge/React-61DAFB?style=flat&logo=React&logoColor=white"/><br>
    </td>
    </tr>
    <tr>
    <td align="center">
    <b>조세림</b></a><br /> 
    <a href="https://github.com/selim-jo">Github</a>
    <br><img src="https://img.shields.io/badge/Node.js-339933?style=flat&logo=Node.js&logoColor=white"/><br>
    </td>
    </tr>
</table>

<br>

## 🕹️ 4. 주요 기능

### 로그인 / 회원가입

- 로컬 회원가입 시 사용자는 이메일 인증을 통해 회원가입을 진행할 수 있습니다.

- 로컬 로그인과 카카오 소셜 로그인 둘 중 편리한 방법을 선택하여 로그인할 수 있습니다.

### 메인 페이지

- 카테고리별로 게시글을 볼 수 있습니다.

- 체험모집 게시글은 모집중이면서 최근 게시글 기준으로 6개씩 보여줍니다.

- 장소추천 게시글은 별점이 높으면서 최근 게시글 기준으로 2개씩 보여줍니다.

- 육아템 리뷰 게시글은 최근 게시글 기준으로 2개씩 보여줍니다.

### 체험모집 게시글

- 원하는 게시글을 클릭하고 상세보기로 들어가면 댓글을 작성할 수 있습니다.

- 무한 스크롤을 통해 게시글을 조회할 수 있습니다.

- 게시글 수정 시 토글을 통해 모집상태를 수정할 수 있습니다.

### 장소추천 게시글

- 게시글 작성 시 다중 이미지를 업로드할 수 있습니다.

- 게시글 조회 시 카카오맵을 통해 장소를 한눈에 볼 수 있습니다.

- 원하는 게시글을 클릭하고 상세보기로 들어가면 댓글을 작성할 수 있습니다.

- 무한 스크롤을 통해 게시글을 조회할 수 있습니다.

### 육아템 리뷰 게시글

- 게시글 작성 시 다중 이미지를 업로드할 수 있습니다.

- 원하는 게시글을 클릭하고 상세보기로 들어가면 댓글을 작성할 수 있습니다.

- 무한 스크롤을 통해 게시글을 조회할 수 있습니다.

### 1:1 실시간 채팅

- 체험모집 게시글에서 관심있는  게시글에 대해 1:1 채팅을 할 수 있습니다.

- 로그인한 상태에서 1:1 실시간 채팅이 오면 화면 왼쪽 아래 알림이 뜹니다.

### 검색

- 게시글의 제목과 내용에 포함된 검색어를 입력하면 검색어가 포함된 게시글을 카테고리별로 보여줍니다.

- 검색한 게시글을 클릭하면 해당 게시글의 상세페이지로 이동합니다.

### 마이페이지(프로필 조회/북마크 조회)

- 프로필 조회에서 프로필 이미지 및 자기소개 수정을 할 수 있습니다.

- 북마크 조회에서 본인이 북마크한 게시글에 대한 정보를 카테코리별로 한눈에 볼 수 있습니다.

<br>

## 🧱 5. 서비스 아키텍처

<img src="https://user-images.githubusercontent.com/91789496/182150151-b651688c-84cc-496c-9dd5-fb7b1579f34f.png" width="600" height="340"/>


<br>

## 🛠 6. 기술스택

기술스택 | 설명
---|:---:
Node.js | 자바스크립트 런타임
Express | 웹 프레임워크
MongoDB | MongoDB
github actions | CI/CD 툴
Nginx | Proxy 서버

<br>

## 📖 7. 라이브러리

라이브러리 | 설명
---|:---:
<img src='https://img.shields.io/badge/artillery-2.0.0-lightgrey'> | 서버 부하 테스트
<img src='https://img.shields.io/badge/bcrypt-5.0.1-lightgrey'> | 비밀번호 암호화
<img src='https://img.shields.io/badge/cors-2.8.5-lightgrey'> | 교차 리소스 공유
<img src='https://img.shields.io/badge/dotenv-16.0.1-lightgrey'>  | 환경변수 관리
<img src='https://img.shields.io/badge/express-4.18.1-lightgrey'> | 서버
<img src='https://img.shields.io/badge/helmet-5.1.0-lightgrey'>  | HTTP 헤더 보안
<img src='https://img.shields.io/badge/joi-17.6.0-lightgrey'>  | 입력데이터 검출
<img src='https://img.shields.io/badge/jest-28.1.2-lightgrey'>  | 테스트 코드
<img src='https://img.shields.io/badge/jsonwebtoken-8.5.1-lightgrey'>  | 서명 암호화
<img src='https://img.shields.io/badge/moment-2.29.4-lightgrey'> | 날짜 라이브러리
<img src='https://img.shields.io/badge/morgan-1.10.0-lightgrey'> | Http Log 기록
<img src='https://img.shields.io/badge/mongoose-6.4.0-lightgrey'> | mongoDB
<img src='https://img.shields.io/badge/swagger--ui--express-4.4.0-lightgrey'> | API 문서화
<img src='https://img.shields.io/badge/winston-3.8.1-lightgrey'> | Log 파일 생성
<img src='https://img.shields.io/badge/winston--daily--rotate--file-4.7.1-lightgrey'> | Log 파일 관리
<img src='https://img.shields.io/badge/multer--s3--transform-2.10.3-lightgrey'> | 이미지 저장
<img src='https://img.shields.io/badge/node--schedule-2.1.0-lightgrey'> | 스케줄 업무 자동화
<img src='https://img.shields.io/badge/socket.io-4.5.1-lightgrey'> | 실시간 통신

<br>

## ❗8. 트러블 슈팅

### 1. 트래픽 처리

  - **어떤 문제점을 겪었는가?**
  
    artillery를 이용하여 부하테스트 진행한 결과 아래와 같이 부하에 취약한 결과가 나옴
    
    ![trobleshooting1](https://user-images.githubusercontent.com/91789496/182510917-737bffb6-0898-4a46-9f05-f5fda178599e.png)

    ![troubleshooting1](https://user-images.githubusercontent.com/91789496/182511686-4419ab29-e35f-4a76-a57a-84d68a5150c6.png)


  - **왜 이런 문제가 발생했는가?**
  
    1. EC2 프리티어의 제한된 성능
    
    2. 비효율적인 로직
  
  - **어떻게 해결했는가?**
  
    1안) `로직 개선`
    
     - 변경 전 코드
     
     ![trobleshooting1](https://user-images.githubusercontent.com/91789496/182513384-57af1276-d677-4ed9-a79d-dac9c933fd4a.png)
     
     - 변경 후 코드
     
     ![troubleshooting1](https://user-images.githubusercontent.com/91789496/182513166-2048bc77-0525-4269-9f52-3ba7db74dce8.png)

    
    2안) `Load Balancing`
    
     - 오토 스케일링을 적용한 ELB를 이용하면 부하에 대한 처리가 편하지만, 비용이 발생하기에 프리티어 인스턴스 3대를 연결하는 방식을 택함
     
     - Nginx를 이용하여 Reverse Proxy 서버를 구축하였으며 Nginx 서버를 Load Balancer로 활용하여 각각의 요청을 EC2 인스턴스에 분산처리하도록 설계하였음
     
     <img src="https://user-images.githubusercontent.com/91789496/182512702-1de8311c-811d-49ca-b4d5-837bed26fe7f.png" width="600" height="340"/>

    
### 2. load balancing 적용 후 socket 통신 오류
    
  - **어떤 문제점을 겪었는가?**
  
    `load balancing 적용 전` -> socket 관련 기능 정상 작동
    
    `load balancing 적용 후` -> socket과 관련된 실시간 채팅, 채팅 알람 미작동

  - **왜 이런 문제가 발생했는가?**
      
    로드 밸런싱 분배 알고리즘을 다르게 설정해보고 다음과 같은 결과가 있었음
    
    1. `Round-Robin`: 실시간 채팅, 알람 기능 미작동
    
    2. `ip_hash`: load balancing에 의해 같은 node server에 있는 유저들 간의 실시간 채팅, 알람 기능은 작동되지만 같은 EC2 서버가 아니면 채팅, 알람이 안되는 현상 발생
  
  - **어떻게 해결했는가?**
  
    ~~소켓과 관련된 요청에는 로드밸런싱 적용을 하지 않고, 하나의 EC2 인스턴스에서만 동작하게 설정~~
    
    =>(2023-03-29일 수정)당시 프로젝트 기간이 촉박했기에 해결하지 못하고, socket 통신에 대해서만 로드밸런싱을 적용하지 않았음.
    
    다른 서버간 socket통신을 연결할 message broker가 필요하였고, 다음과 같은 이유로 redis를 socket adapter로 채택하여 Pub/Sub 기능을 적용하여 해결.
    
    
    1.성능적인 부분: 전송한 메세지를 보유할 필요가 없으며, 처리할 데이터의 양이 크지 않음

    2.Push Based Subscription 방식: kafka의 경우 subscriber가 pull요청을 날려야 Message를 받아오는 방식인 반면, 
    
    Redis는 Publisher가 publish하면 자동으로 그 시점에 구독자들에게 메세지를 모두 날리는 방식으로 더 적합하다 판단하여 Redis사용
    
    
### 3. 이미지 파일 업로드 중 오류 발생

  - **어떤 문제점을 겪었는가?**
  
    게시글에서 이미지 파일 업로드 중 413 오류 발생으로 게시글 작성이 되지 않는 오류 발생

  - **왜 이런 문제가 발생했는가?**
  
    1. 파일 용량 초과로 인해 발생한 오류 -> nginx의 기본 업로드 제한이 1MB이기 때문에 문제 발생
    2. nginx를 이용해 웹 서버를 구동해 multer-s3에서 기본 업로드 제한을 두어도 적용되지 않음

  - **어떻게 해결했는가?**
    
    nginx conf 파일에 기본 업로드 제한 용량을 `10M`로 늘려 설정
  
   <img src="https://user-images.githubusercontent.com/91789496/182509225-71c6edcc-d8af-4631-be1e-bfcb5dda420e.png" width="400" height="200"/>

<br>

## ⭐️ 9. 유저 피드백


### 1. 채팅창 개선

  - **유저 의견**
  
    "채팅조회 시, 한 사용자의 여러 게시글에 채팅을 했을 때 어떤 게시글에 대해 채팅을 했는지 헷갈려 불편해요"
  
  - **해결완료**

    채팅조회할 때도 게시글 제목이 보이게 해 사용자의 편의성을 높임
    
    <img src="https://user-images.githubusercontent.com/91789496/183235886-1af840ff-19d2-440f-8349-734004b07b23.png" width="600" height="340"/>
    
### 2. 모집 날짜가 지났을 때의 모집 상태 변경 자동화

  - **유저 의견**
  
    "직접 모집완료로 변경하는것이 불편하고 까먹어 날짜가 지나도 모집중인 게시글이 있어 헷갈립니다."
  
  - **해결완료**

    모집날짜가 지났을 때 자동으로 모집상태 변경을 서버에게 요청하여 자동으로 변경되게 개선
    
    <img src="https://user-images.githubusercontent.com/91789496/183235901-e9cfa853-5a0a-4e8e-8be8-6449501adb14.png" width="600" height="340"/>
